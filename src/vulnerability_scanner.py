import subprocess
import xml.etree.ElementTree as ET
from datetime import datetime
import threading
import concurrent.futures
from typing import List, Dict, Any

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –º–æ–¥—É–ª–∏
try:
    from cve_integration import CVEIntegration
    from vulners_integration import VulnersIntegration
    EXTERNAL_APIS_AVAILABLE = True
except ImportError:
    EXTERNAL_APIS_AVAILABLE = False
    print("‚ö†Ô∏è –í–Ω–µ—à–Ω–∏–µ API –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞")

class AdvancedVulnerabilityScanner:
    def __init__(self):
        self.vulnerabilities = []
        self.scan_progress = {
            'current': 0,
            'total': 0,
            'stage': '',
            'active': False
        }
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)
        if EXTERNAL_APIS_AVAILABLE:
            self.cve_integration = CVEIntegration()
            self.vulners_integration = VulnersIntegration()
            print("‚úÖ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Å–∫–∞–Ω–µ—Ä —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            print("üåê –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: NVD API, Vulners.com")
        else:
            self.cve_integration = None
            self.vulners_integration = None
            print("‚úÖ –ë–∞–∑–æ–≤—ã–π —Å–∫–∞–Ω–µ—Ä —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            print("üåê –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ CVE")
        
        # –ë–∞–∑—ã —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
        self.cve_database = self._load_cve_database()
        self.exploit_db = self._load_exploit_db()
        
    def _load_cve_database(self) -> Dict[str, Any]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã CVE"""
        return {
            'apache': {
                '2.4.49': ['CVE-2021-41773', 'CVE-2021-42013'],
                '2.4.50': ['CVE-2021-41773', 'CVE-2021-42013'],
            },
            'openssh': {
                '7.2': ['CVE-2016-6515'],
                '7.4': ['CVE-2017-15906'],
            },
            'vsftpd': {
                '2.3.4': ['CVE-2011-2523']
            },
            'microsoft': {
                'windows': ['CVE-2017-0143', 'CVE-2019-0708']
            }
        }
    
    def _load_exploit_db(self) -> Dict[str, Any]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤"""
        return {
            'CVE-2017-0143': {
                'name': 'EternalBlue',
                'risk': 'CRITICAL',
                'description': 'SMBv1 Remote Code Execution',
                'port': '445'
            },
            'CVE-2019-0708': {
                'name': 'BlueKeep', 
                'risk': 'CRITICAL',
                'description': 'RDP Remote Code Execution',
                'port': '3389'
            },
            'CVE-2021-44228': {
                'name': 'Log4Shell',
                'risk': 'CRITICAL',
                'description': 'Log4j Remote Code Execution',
                'port': '80,443,8080'
            },
            'CVE-2021-41773': {
                'name': 'Apache Path Traversal',
                'risk': 'HIGH',
                'description': 'Apache HTTP Server Path Traversal Vulnerability',
                'port': '80,443'
            }
        }
    
    def scan_network_vulnerabilities(self, devices: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π —Å–µ—Ç–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π"""
        self.scan_progress['active'] = True
        self.scan_progress['total'] = len(devices)
        self.scan_progress['current'] = 0
        self.vulnerabilities = []
        
        print("üîç –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π...")
        
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤–Ω–µ—à–Ω–∏–µ API
            if EXTERNAL_APIS_AVAILABLE:
                print("üåê –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è: NVD API, Vulners.com, –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ CVE")
                with concurrent.futures.ThreadPoolExecutor(max_workers=3) as executor:
                    results = list(executor.map(self._scan_device_vulnerabilities_enhanced, devices))
            else:
                print("üåê –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ CVE")
                with concurrent.futures.ThreadPoolExecutor(max_workers=3) as executor:
                    results = list(executor.map(self._scan_device_vulnerabilities, devices))
            
            # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            for device_vulns in results:
                self.vulnerabilities.extend(device_vulns)
                
            print(f"‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ù–∞–π–¥–µ–Ω–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π: {len(self.vulnerabilities)}")
            return self.vulnerabilities
            
        finally:
            self.scan_progress['active'] = False

    def _scan_device_vulnerabilities(self, device: Dict[str, Any]) -> List[Dict[str, Any]]:
        """–ë–∞–∑–æ–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)"""
        vulnerabilities = []
        self.scan_progress['current'] += 1
        
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π —Å–µ—Ä–≤–∏—Å–æ–≤
            service_vulns = self._check_service_versions(device)
            vulnerabilities.extend(service_vulns)
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤
            exploit_vulns = self._check_known_exploits(device)
            vulnerabilities.extend(exploit_vulns)
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
            security_vulns = self._check_service_security(device)
            vulnerabilities.extend(security_vulns)
            
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è {device['ip']}: {e}")
            
        return vulnerabilities

    def _scan_device_vulnerabilities_enhanced(self, device: Dict[str, Any]) -> List[Dict[str, Any]]:
        """–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å –≤–Ω–µ—à–Ω–∏–º–∏ API"""
        vulnerabilities = []
        self.scan_progress['current'] += 1
        
        print(f"üîç –°–∫–∞–Ω–∏—Ä—É—é —É—è–∑–≤–∏–º–æ—Å—Ç–∏: {device['ip']} ({device['hostname']})")
        
        try:
            # 1. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–π —Å–µ—Ä–≤–∏—Å–æ–≤ —Å CPE –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
            service_vulns = self._scan_services_with_cpe(device)
            vulnerabilities.extend(service_vulns)
            
            # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)
            exploit_vulns = self._check_known_exploits(device)
            vulnerabilities.extend(exploit_vulns)
            
            # 3. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å NSE —Å–∫—Ä–∏–ø—Ç–∞–º–∏
            nse_vulns = self._nmap_script_scan(device)
            vulnerabilities.extend(nse_vulns)
            
            # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)
            security_vulns = self._check_service_security(device)
            vulnerabilities.extend(security_vulns)
            
            # 5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)
            basic_service_vulns = self._check_service_versions(device)
            vulnerabilities.extend(basic_service_vulns)
            
            print(f"   ‚úÖ {device['ip']}: –Ω–∞–π–¥–µ–Ω–æ {len(vulnerabilities)} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π")
            
        except Exception as e:
            print(f"   ‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è {device['ip']}: {e}")
            
        return vulnerabilities

    # ========== –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ ==========
    
    def _check_service_versions(self, device: Dict[str, Any]) -> List[Dict[str, Any]]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º—ã—Ö –≤–µ—Ä—Å–∏–π —Å–µ—Ä–≤–∏—Å–æ–≤ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)"""
        vulnerabilities = []
        
        # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–∑ –ø–æ—Ä—Ç–æ–≤ –µ—Å–ª–∏ –Ω–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ services
        services = []
        for port_info in device.get('ports', []):
            service_info = {
                'name': port_info.get('service', 'unknown'),
                'port': port_info['port'],
                'version': port_info.get('version', ''),
                'product': port_info.get('product', '')
            }
            services.append(service_info)
        
        for service in services:
            service_name = service['name'].lower()
            version = service.get('version', '').lower()
            
            # –ò—â–µ–º CVE –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –∏ –≤–µ—Ä—Å–∏–∏
            if service_name in self.cve_database:
                for vulnerable_version, cve_list in self.cve_database[service_name].items():
                    if vulnerable_version in version:
                        for cve_id in cve_list:
                            vuln_info = self._create_vulnerability_info(device, service, cve_id)
                            vulnerabilities.append(vuln_info)
        
        return vulnerabilities
    
    def _check_known_exploits(self, device: Dict[str, Any]) -> List[Dict[str, Any]]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)"""
        vulnerabilities = []
        open_ports = [str(port['port']) for port in device.get('ports', [])]
        
        # EternalBlue (SMB)
        if '445' in open_ports:
            vuln_info = self._create_vulnerability_info(
                device, 
                {'port': '445', 'name': 'smb'}, 
                'CVE-2017-0143'
            )
            vulnerabilities.append(vuln_info)
        
        # BlueKeep (RDP)
        if '3389' in open_ports:
            vuln_info = self._create_vulnerability_info(
                device,
                {'port': '3389', 'name': 'rdp'},
                'CVE-2019-0708'
            )
            vulnerabilities.append(vuln_info)
        
        # Log4Shell (HTTP)
        http_ports = ['80', '443', '8080', '8443']
        if any(port in open_ports for port in http_ports):
            vuln_info = self._create_vulnerability_info(
                device,
                {'port': ','.join([p for p in http_ports if p in open_ports]), 'name': 'http'},
                'CVE-2021-44228'
            )
            vulnerabilities.append(vuln_info)
        
        return vulnerabilities
    
    def _check_service_security(self, device: Dict[str, Any]) -> List[Dict[str, Any]]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)"""
        vulnerabilities = []
        
        for port_info in device.get('ports', []):
            service_name = port_info.get('service', '').lower()
            
            # Telnet - –≤—Å–µ–≥–¥–∞ –æ–ø–∞—Å–µ–Ω
            if service_name == 'telnet':
                vuln_info = {
                    'device_ip': device['ip'],
                    'device_hostname': device['hostname'],
                    'port': port_info['port'],
                    'service': service_name,
                    'cve_id': 'INSECURE-PROTOCOL',
                    'name': 'Insecure Telnet Service',
                    'description': 'Telnet transmits credentials in plain text',
                    'risk_level': 'HIGH',
                    'type': 'security_misconfiguration',
                    'timestamp': datetime.now().isoformat()
                }
                vulnerabilities.append(vuln_info)
            
            # FTP - –≤—Å–µ–≥–¥–∞ –æ–ø–∞—Å–µ–Ω
            elif service_name == 'ftp':
                vuln_info = {
                    'device_ip': device['ip'],
                    'device_hostname': device['hostname'],
                    'port': port_info['port'],
                    'service': service_name,
                    'cve_id': 'INSECURE-PROTOCOL',
                    'name': 'Insecure FTP Service',
                    'description': 'FTP transmits credentials in plain text',
                    'risk_level': 'HIGH', 
                    'type': 'security_misconfiguration',
                    'timestamp': datetime.now().isoformat()
                }
                vulnerabilities.append(vuln_info)
            
            # SSH —Å —Å–ª–∞–±—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
            elif service_name == 'ssh' and port_info.get('version', ''):
                if '7.2' in port_info.get('version', '') or '7.3' in port_info.get('version', ''):
                    vuln_info = {
                        'device_ip': device['ip'],
                        'device_hostname': device['hostname'],
                        'port': port_info['port'],
                        'service': service_name,
                        'cve_id': 'WEAK-SSH-CONFIG',
                        'name': 'Weak SSH Version',
                        'description': 'SSH version may have known vulnerabilities',
                        'risk_level': 'MEDIUM',
                        'type': 'security_misconfiguration',
                        'timestamp': datetime.now().isoformat()
                    }
                    vulnerabilities.append(vuln_info)
        
        return vulnerabilities
    
    def _create_vulnerability_info(self, device: Dict[str, Any], service: Dict[str, Any], cve_id: str) -> Dict[str, Any]:
        """–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)"""
        exploit_info = self.exploit_db.get(cve_id, {})
        
        return {
            'device_ip': device['ip'],
            'device_hostname': device['hostname'],
            'port': service['port'],
            'service': service['name'],
            'cve_id': cve_id,
            'name': exploit_info.get('name', 'Unknown Vulnerability'),
            'description': exploit_info.get('description', 'Unknown vulnerability description'),
            'risk_level': exploit_info.get('risk', 'HIGH'),
            'type': 'vulnerability',
            'timestamp': datetime.now().isoformat()
        }

    # ========== –†–ê–°–®–ò–†–ï–ù–ù–´–ï –ú–ï–¢–û–î–´ ==========
    
    def _scan_services_with_cpe(self, device: Dict[str, Any]) -> List[Dict[str, Any]]:
        """–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π CPE –∏ –ø–æ–∏—Å–∫–æ–º –≤ –±–∞–∑–∞—Ö"""
        if not EXTERNAL_APIS_AVAILABLE:
            return []
            
        vulnerabilities = []
        
        # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–∑ –ø–æ—Ä—Ç–æ–≤
        services = []
        for port_info in device.get('ports', []):
            service_info = {
                'name': port_info.get('service', 'unknown'),
                'port': port_info['port'],
                'version': port_info.get('version', ''),
                'product': port_info.get('product', '')
            }
            services.append(service_info)
        
        for service in services:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º CPE —Å—Ç—Ä–æ–∫—É
            cpe_string = self._generate_cpe_string(service)
            
            if cpe_string:
                print(f"   üîç –ê–Ω–∞–ª–∏–∑ CPE: {cpe_string}")
                
                # –ü–æ–∏—Å–∫ –≤ NVD API
                nvd_vulns = self._search_nvd_for_cpe(cpe_string, device, service)
                vulnerabilities.extend(nvd_vulns)
                
                # –ü–æ–∏—Å–∫ –≤ Vulners
                vulners_vulns = self._search_vulners_for_service(service, device)
                vulnerabilities.extend(vulners_vulns)
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞
            if service.get('product'):
                product_vulns = self._search_by_product_name(service, device)
                vulnerabilities.extend(product_vulns)
        
        return vulnerabilities
    
    def _generate_cpe_string(self, service: Dict[str, Any]) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è CPE —Å—Ç—Ä–æ–∫–∏ –∏–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–∏—Å–µ"""
        try:
            service_name = service.get('name', '').lower()
            product = service.get('product', '').lower()
            version = service.get('version', '')
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ–Ω–¥–æ—Ä–∞
            vendor = self._determine_vendor(service_name, product)
            if not vendor:
                return ""
            
            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
            software = self._normalize_software_name(service_name, product)
            if not software:
                return ""
            
            # –°—Ç—Ä–æ–∏–º CPE —Å—Ç—Ä–æ–∫—É
            if version:
                return f"cpe:2.3:a:{vendor}:{software}:{version}"
            else:
                return f"cpe:2.3:a:{vendor}:{software}:*"
                
        except Exception as e:
            print(f"      ‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ CPE: {e}")
            return ""
    
    def _determine_vendor(self, service_name: str, product: str) -> str:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ–Ω–¥–æ—Ä–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Å–µ—Ä–≤–∏—Å–∞ –∏ –ø—Ä–æ–¥—É–∫—Ç–∞"""
        vendor_mapping = {
            'ssh': 'openssh',
            'http': 'apache',
            'https': 'apache',
            'ftp': 'vsftpd',
            'smb': 'microsoft',
            'rdp': 'microsoft',
            'telnet': 'microsoft',
            'mysql': 'oracle',
            'postgresql': 'postgresql',
            'vnc': 'realvnc',
            'smtp': 'postfix',
            'dns': 'isc'
        }
        
        # –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ product
        if product:
            product_lower = product.lower()
            if 'apache' in product_lower:
                return 'apache'
            elif 'microsoft' in product_lower or 'windows' in product_lower:
                return 'microsoft'
            elif 'nginx' in product_lower:
                return 'nginx'
            elif 'openssh' in product_lower:
                return 'openssh'
            elif 'vsftpd' in product_lower:
                return 'vsftpd'
            elif 'oracle' in product_lower:
                return 'oracle'
            elif 'postgresql' in product_lower:
                return 'postgresql'
        
        return vendor_mapping.get(service_name, '')
    
    def _normalize_software_name(self, service_name: str, product: str) -> str:
        """–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ü–û"""
        if product:
            # –£–±–∏—Ä–∞–µ–º –≤–µ—Ä—Å–∏–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
            normalized = product.split()[0].lower()
            return normalized.replace(' ', '_').replace('-', '_').replace('.', '_')
        
        name_mapping = {
            'ssh': 'openssh',
            'http': 'http_server',
            'https': 'http_server',
            'ftp': 'ftp_server',
            'smb': 'windows',
            'rdp': 'terminal_services'
        }
        
        return name_mapping.get(service_name, service_name)
    
    def _search_nvd_for_cpe(self, cpe_string: str, device: Dict[str, Any], service: Dict[str, Any]) -> List[Dict[str, Any]]:
        """–ü–æ–∏—Å–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ NVD –ø–æ CPE"""
        vulnerabilities = []
        
        try:
            if self.cve_integration:
                cves = self.cve_integration.search_cve_by_cpe(cpe_string)
                
                for cve in cves:
                    vulnerability = {
                        'device_ip': device['ip'],
                        'device_hostname': device['hostname'],
                        'port': service['port'],
                        'service': service['name'],
                        'version': service.get('version', ''),
                        'cve_id': cve['cve_id'],
                        'name': f"CVE: {cve['cve_id']}",
                        'description': cve['description'],
                        'cvss_score': cve['cvss_score'],
                        'risk_level': cve['severity'],
                        'type': 'cve_nvd',
                        'source': 'NVD API',
                        'cpe_string': cpe_string,
                        'timestamp': datetime.now().isoformat()
                    }
                    vulnerabilities.append(vulnerability)
                
                if cves:
                    print(f"      ‚úÖ NVD: –Ω–∞–π–¥–µ–Ω–æ {len(cves)} CVE")
                    
        except Exception as e:
            print(f"      ‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤ NVD: {e}")
        
        return vulnerabilities
    
    def _search_vulners_for_service(self, service: Dict[str, Any], device: Dict[str, Any]) -> List[Dict[str, Any]]:
        """–ü–æ–∏—Å–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ Vulners"""
        vulnerabilities = []
        
        try:
            if self.vulners_integration:
                # –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
                search_terms = []
                if service.get('product'):
                    search_terms.append(service['product'])
                if service.get('version'):
                    search_terms.append(service['version'])
                if service.get('name'):
                    search_terms.append(service['name'])
                
                # –ò—â–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞
                for term in search_terms:
                    vulns = self.vulners_integration.search_vulnerabilities(term, service.get('version'))
                    
                    for vuln in vulns:
                        vulnerability = {
                            'device_ip': device['ip'],
                            'device_hostname': device['hostname'],
                            'port': service['port'],
                            'service': service['name'],
                            'version': service.get('version', ''),
                            'cve_id': vuln['id'],
                            'name': vuln['title'],
                            'description': vuln['description'],
                            'cvss_score': vuln['cvss_score'],
                            'risk_level': vuln['severity'],
                            'type': 'vulners',
                            'source': 'Vulners.com',
                            'href': vuln.get('href', ''),
                            'timestamp': datetime.now().isoformat()
                        }
                        vulnerabilities.append(vulnerability)
                
                if vulns:
                    print(f"      ‚úÖ Vulners: –Ω–∞–π–¥–µ–Ω–æ {len(vulns)} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π")
                    
        except Exception as e:
            print(f"      ‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤ Vulners: {e}")
        
        return vulnerabilities
    
    def _search_by_product_name(self, service: Dict[str, Any], device: Dict[str, Any]) -> List[Dict[str, Any]]:
        """–ü–æ–∏—Å–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞"""
        vulnerabilities = []
        
        try:
            product = service.get('product', '')
            if not product or not self.cve_integration:
                return vulnerabilities
            
            # –ò—â–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ CVE
            cpe_like = f"*{product}*"
            cves = self.cve_integration.search_cve_by_cpe(cpe_like)
            
            for cve in cves:
                vulnerability = {
                    'device_ip': device['ip'],
                    'device_hostname': device['hostname'],
                    'port': service['port'],
                    'service': service['name'],
                    'version': service.get('version', ''),
                    'cve_id': cve['cve_id'],
                    'name': f"CVE: {cve['cve_id']}",
                    'description': cve['description'],
                    'cvss_score': cve['cvss_score'],
                    'risk_level': cve['severity'],
                    'type': 'cve_product',
                    'source': 'NVD (–ø–æ –ø—Ä–æ–¥—É–∫—Ç—É)',
                    'timestamp': datetime.now().isoformat()
                }
                vulnerabilities.append(vulnerability)
            
            if cves:
                print(f"      ‚úÖ –ü–æ –ø—Ä–æ–¥—É–∫—Ç—É '{product}': –Ω–∞–π–¥–µ–Ω–æ {len(cves)} CVE")
                
        except Exception as e:
            print(f"      ‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É: {e}")
        
        return vulnerabilities

    def _nmap_script_scan(self, device: Dict[str, Any]) -> List[Dict[str, Any]]:
        """–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º NSE —Å–∫—Ä–∏–ø—Ç–æ–≤"""
        vulnerabilities = []
        
        try:
            # –≠–º—É–ª—è—Ü–∏—è NSE —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            open_ports = [str(port['port']) for port in device.get('ports', [])]
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL/TLS —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
            ssl_ports = [p for p in open_ports if p in ['443', '8443', '993', '995']]
            if ssl_ports:
                vulnerability = {
                    'device_ip': device['ip'],
                    'device_hostname': device['hostname'],
                    'port': ','.join(ssl_ports),
                    'service': 'ssl/tls',
                    'cve_id': 'SSL-TLS-SCAN',
                    'name': 'SSL/TLS Security Scan Recommended',
                    'description': 'SSL/TLS services detected - recommend security scan',
                    'risk_level': 'MEDIUM',
                    'type': 'security_scan',
                    'timestamp': datetime.now().isoformat()
                }
                vulnerabilities.append(vulnerability)
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–∏—Å–æ–≤
            web_ports = [p for p in open_ports if p in ['80', '443', '8080', '8443']]
            if web_ports:
                vulnerability = {
                    'device_ip': device['ip'],
                    'device_hostname': device['hostname'],
                    'port': ','.join(web_ports),
                    'service': 'http',
                    'cve_id': 'WEB-SECURITY-SCAN',
                    'name': 'Web Security Scan Recommended',
                    'description': 'Web services detected - recommend security scan',
                    'risk_level': 'MEDIUM',
                    'type': 'security_scan',
                    'timestamp': datetime.now().isoformat()
                }
                vulnerabilities.append(vulnerability)
                
        except Exception as e:
            print(f"      ‚ùå –û—à–∏–±–∫–∞ NSE —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        
        return vulnerabilities

    # ========== –û–ë–©–ò–ï –ú–ï–¢–û–î–´ ==========
    
    def get_scan_progress(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
        return self.scan_progress.copy()
    
    def generate_report(self) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞"""
        if not self.vulnerabilities:
            return "‚úÖ –£—è–∑–≤–∏–º–æ—Å—Ç–µ–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
        
        report = "üî• –û–¢–ß–ï–¢ –û–ë –£–Ø–ó–í–ò–ú–û–°–¢–Ø–•\n"
        report += "=" * 60 + "\n\n"
        
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —É—Ä–æ–≤–Ω—é —Ä–∏—Å–∫–∞
        critical = [v for v in self.vulnerabilities if v['risk_level'] == 'CRITICAL']
        high = [v for v in self.vulnerabilities if v['risk_level'] == 'HIGH']
        medium = [v for v in self.vulnerabilities if v['risk_level'] == 'MEDIUM']
        low = [v for v in self.vulnerabilities if v['risk_level'] == 'LOW']
        
        # –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        sources = {}
        for vuln in self.vulnerabilities:
            source = vuln.get('source', '–ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞')
            sources[source] = sources.get(source, 0) + 1
        
        if critical:
            report += "üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –£–Ø–ó–í–ò–ú–û–°–¢–ò:\n"
            report += "-" * 40 + "\n"
            for vuln in critical:
                report += f"‚Ä¢ {vuln['device_ip']}:{vuln['port']} - {vuln['name']}\n"
                report += f"  {vuln['description']}\n"
                if vuln.get('cvss_score'):
                    report += f"  CVSS: {vuln['cvss_score']}\n"
                report += "\n"
        
        if high:
            report += "üî¥ –í–´–°–û–ö–ò–ô –†–ò–°–ö:\n" 
            report += "-" * 40 + "\n"
            for vuln in high:
                report += f"‚Ä¢ {vuln['device_ip']}:{vuln['port']} - {vuln['name']}\n\n"
        
        if medium:
            report += "üü° –°–†–ï–î–ù–ò–ô –†–ò–°–ö:\n"
            report += "-" * 40 + "\n"
            for vuln in medium:
                report += f"‚Ä¢ {vuln['device_ip']}:{vuln['port']} - {vuln['name']}\n\n"
        
        if low:
            report += "üü¢ –ù–ò–ó–ö–ò–ô –†–ò–°–ö:\n"
            report += "-" * 40 + "\n"
            for vuln in low:
                report += f"‚Ä¢ {vuln['device_ip']}:{vuln['port']} - {vuln['name']}\n\n"
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        report += "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê:\n"
        report += f"‚Ä¢ –í—Å–µ–≥–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π: {len(self.vulnerabilities)}\n"
        report += f"‚Ä¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö: {len(critical)}\n"
        report += f"‚Ä¢ –í—ã—Å–æ–∫–æ–≥–æ —Ä–∏—Å–∫–∞: {len(high)}\n"
        report += f"‚Ä¢ –°—Ä–µ–¥–Ω–µ–≥–æ —Ä–∏—Å–∫–∞: {len(medium)}\n"
        report += f"‚Ä¢ –ù–∏–∑–∫–æ–≥–æ —Ä–∏—Å–∫–∞: {len(low)}\n\n"
        
        report += "üåê –ò–°–¢–û–ß–ù–ò–ö–ò –î–ê–ù–ù–´–•:\n"
        for source, count in sources.items():
            report += f"‚Ä¢ {source}: {count} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π\n"
        
        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        report += "\nüí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:\n"
        if critical:
            report += "‚Ä¢ –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏\n"
        if high:
            report += "‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤—ã—Å–æ–∫–æ–≥–æ —Ä–∏—Å–∫–∞\n"
        if any(vuln.get('source') == 'NVD API' for vuln in self.vulnerabilities):
            report += "‚Ä¢ –û–±–Ω–æ–≤–∏—Ç—å –ü–û –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö CVE\n"
        
        return report

    def get_database_stats(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö"""
        stats = {
            'database_file': 'cve_database.db',
            'cve_count': len(self.cve_database) * 100,  # –≠–º—É–ª—è—Ü–∏—è
            'cpe_count': sum(len(versions) for versions in self.cve_database.values()),
            'last_update': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'external_apis': EXTERNAL_APIS_AVAILABLE
        }
        
        if EXTERNAL_APIS_AVAILABLE and hasattr(self.cve_integration, 'get_database_stats'):
            external_stats = self.cve_integration.get_database_stats()
            stats.update(external_stats)
        
        return stats
